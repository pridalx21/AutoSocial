{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <!-- Linke Spalte: Eingabeformular -->
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">Content Generator</h5>
                </div>
                <div class="card-body">
                    <form id="contentForm" class="needs-validation" novalidate>
                        <div class="mb-3">
                            <label for="content-type" class="form-label">Content Type</label>
                            <select class="form-select" id="content-type" name="content-type" required>
                                <option value="lifestyle">Lifestyle</option>
                                <option value="food">Food</option>
                                <option value="travel">Travel</option>
                                <option value="fashion">Fashion</option>
                                <option value="tech">Tech</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="tone" class="form-label">Tone</label>
                            <select class="form-select" id="tone" name="tone" required>
                                <option value="professional">Professional</option>
                                <option value="casual">Casual</option>
                                <option value="funny">Funny</option>
                                <option value="inspirational">Inspirational</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="interests" class="form-label">Target Interests</label>
                            <select class="form-select" id="interests" name="interests" multiple required>
                                <option value="photography">Photography</option>
                                <option value="art">Art</option>
                                <option value="music">Music</option>
                                <option value="sports">Sports</option>
                                <option value="technology">Technology</option>
                                <option value="fashion">Fashion</option>
                                <option value="food">Food</option>
                                <option value="travel">Travel</option>
                            </select>
                            <div class="form-text">Hold Ctrl/Cmd to select multiple interests</div>
                        </div>

                        <div class="mb-3">
                            <label for="age-range" class="form-label">Target Age Range</label>
                            <select class="form-select" id="age-range" name="age-range" required>
                                <option value="18-24">18-24</option>
                                <option value="25-34">25-34</option>
                                <option value="35-44">35-44</option>
                                <option value="45-54">45-54</option>
                                <option value="55+">55+</option>
                            </select>
                        </div>

                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-magic me-2"></i>Generate Content
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Rechte Spalte: Vorschau -->
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">Post Preview</h5>
                </div>
                <div class="card-body">
                    <div id="previewContainer" class="d-none">
                        <!-- Instagram-Style Post Preview -->
                        <div class="instagram-post border rounded">
                            <div class="post-header d-flex align-items-center p-3">
                                <img src="{{ url_for('static', filename='img/profile.png') }}" alt="Profile" class="rounded-circle me-2" style="width: 32px; height: 32px;">
                                <span class="fw-bold">{{ session.get('user_info', {}).get('username', 'Your Profile') }}</span>
                            </div>
                            
                            <!-- Image Container mit fixem SeitenverhÃ¤ltnis -->
                            <div class="position-relative" style="padding-bottom: 100%;">
                                <img id="previewImage" src="" alt="Generated Image" class="position-absolute top-0 start-0 w-100 h-100 object-fit-cover">
                            </div>
                            
                            <!-- Engagement Icons -->
                            <div class="post-actions d-flex gap-3 p-3">
                                <i class="bi bi-heart fs-4"></i>
                                <i class="bi bi-chat fs-4"></i>
                                <i class="bi bi-send fs-4"></i>
                                <i class="bi bi-bookmark fs-4 ms-auto"></i>
                            </div>
                            
                            <!-- Caption und Hashtags -->
                            <div class="post-content p-3">
                                <p class="mb-1">
                                    <span class="fw-bold">{{ session.get('user_info', {}).get('username', 'Your Profile') }}</span>
                                    <span id="previewCaption"></span>
                                </p>
                                <p class="text-muted" id="previewHashtags"></p>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="mt-3">
                            <button id="scheduleButton" class="btn btn-success w-100 mb-2">
                                <i class="bi bi-calendar-check me-2"></i>Schedule Post
                            </button>
                            <button id="regenerateButton" class="btn btn-outline-primary w-100">
                                <i class="bi bi-arrow-clockwise me-2"></i>Regenerate
                            </button>
                        </div>
                    </div>
                    
                    <!-- Loading Spinner -->
                    <div id="loadingSpinner" class="text-center d-none">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Generating your content...</p>
                    </div>
                    
                    <!-- Initial State -->
                    <div id="initialState" class="text-center py-5">
                        <i class="bi bi-image text-muted" style="font-size: 4rem;"></i>
                        <p class="text-muted mt-3">Fill out the form to generate content</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('contentForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // Show loading spinner
    document.getElementById('initialState').classList.add('d-none');
    document.getElementById('previewContainer').classList.add('d-none');
    document.getElementById('loadingSpinner').classList.remove('d-none');
    
    // Get form data
    const interests = Array.from(document.getElementById('interests').selectedOptions).map(option => option.value);
    const data = {
        contentType: document.getElementById('content-type').value,
        tone: document.getElementById('tone').value,
        interests: interests,
        ageRange: document.getElementById('age-range').value
    };
    
    try {
        const response = await fetch('/api/generate-content', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        
        const result = await response.json();
        
        // Update preview
        document.getElementById('previewImage').src = result.imageUrl;
        document.getElementById('previewCaption').textContent = result.caption;
        document.getElementById('previewHashtags').textContent = result.hashtags.map(tag => '#' + tag).join(' ');
        
        // Hide loading spinner and show preview
        document.getElementById('loadingSpinner').classList.add('d-none');
        document.getElementById('previewContainer').classList.remove('d-none');
        
    } catch (error) {
        console.error('Error:', error);
        alert('Error generating content. Please try again.');
        document.getElementById('loadingSpinner').classList.add('d-none');
        document.getElementById('initialState').classList.remove('d-none');
    }
});

// Regenerate button
document.getElementById('regenerateButton').addEventListener('click', function() {
    document.getElementById('contentForm').dispatchEvent(new Event('submit'));
});

// Schedule button
document.getElementById('scheduleButton').addEventListener('click', async function() {
    const imageUrl = document.getElementById('previewImage').src;
    const caption = document.getElementById('previewCaption').textContent;
    const hashtags = document.getElementById('previewHashtags').textContent
        .split(' ')
        .map(tag => tag.replace('#', ''))
        .filter(tag => tag);
        
    try {
        const response = await fetch('/api/schedule-post', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                imageUrl,
                caption,
                hashtags
            })
        });
        
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        
        const result = await response.json();
        alert('Post scheduled successfully!');
        window.location.href = '/dashboard';
        
    } catch (error) {
        console.error('Error:', error);
        alert('Error scheduling post. Please try again.');
    }
});
</script>
{% endblock %}
